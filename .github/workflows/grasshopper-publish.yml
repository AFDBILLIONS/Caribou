name: Publish Grasshopper Plugin

on:
  release:
    types: [created]

jobs:

  build:

    runs-on: windows-latest  # For a list of available runner types, refer to
                             # https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on

    env:
      Solution_Name: Caribou    # Replace with your solution name, i.e. MyWpfApp
      Release_File_Path: '.\Caribou\bin\Release\net45'
      YAK_TOKEN: ${{ secrets.YAK_TOKEN }}
      AUTHID:  ${{ secrets.AUTHID }}

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    # Add MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v1.0.2
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

    # Add NuGet to the PATH: https://github.com/marketplace/actions/setup-nuget-exe-for-use-with-actions
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

    # Restore NuGet packages
    - name: Restore the application
      run: msbuild $env:Solution_Name /t:Restore /p:Configuration=Release

    # Build the application
    - name: Build the application
      run: msbuild $env:Solution_Name /p:Configuration=Release

    # Publish to Yak upon releases
    - name: Push main version to Yak
      uses: pfmephisto/rhino-yak@v1
      with:
        build-directory: ${{ env.Release_File_Path }}
        version: "$Env:SimpleVersion"
